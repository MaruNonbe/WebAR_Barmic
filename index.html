<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>ARキャラクター - 最終修正版</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

  <style>
    /* 画面全体の設定 */
    html, body { 
      margin: 0; padding: 0; width: 100%; height: 100%; 
      overflow: hidden; background-color: #000;
    }

    /* AR.jsが生成するビデオ要素を画面一杯に背面に固定 */
    #arjs-video {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      object-fit: cover !important;
      z-index: -2 !important;
    }

    /* A-Frameの描画キャンバスをビデオのすぐ上に配置 */
    .a-canvas {
      z-index: -1 !important;
    }

    /* UIボタンコンテナ：iPhoneのバーを避ける */
    #ui-container {
      position: fixed;
      bottom: calc(30px + env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      z-index: 1000;
      display: flex;
      justify-content: center;
      gap: 10px;
      pointer-events: none;
    }

    .btn {
      padding: 15px 5px;
      background: white;
      color: #333;
      border-radius: 10px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      pointer-events: auto;
      flex: 1;
      max-width: 80px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active { background: #ddd; }
  </style>
</head>
<body>

<a-scene
  embedded
  vr-mode-ui="enabled: false"
  arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
  renderer="logarithmicDepthBuffer: true; colorManagement: true; antialias: true;"
>
  <a-assets>
    <a-asset-item id="char-model" src="HandRaising.glb"></a-asset-item>
  </a-assets>

  <a-light type="ambient" intensity="1.2"></a-light>
  <a-light type="directional" position="1 4 2" intensity="1.0"></a-light>

  <a-camera rotation-reader></a-camera>

  <a-entity id="character"
            gltf-model="#char-model"
            position="0 0 -8"
            scale="1 1 1"
            rotation="0 0 0"
            animation-mixer="clip: *; loop: repeat;">
  </a-entity>
</a-scene>

<div id="ui-container">
  <button class="btn" id="btn-bigger">拡大</button>
  <button class="btn" id="btn-smaller">縮小</button>
  <button class="btn" id="btn-rotate">回転</button>
  <button class="btn" id="btn-capture">撮影</button>
</div>

<script>
  const char = document.querySelector('#character');
  let currentScale = 1.0;
  let currentRotation = 0;

  // ボタンイベント登録
  document.getElementById('btn-bigger').addEventListener('click', () => {
    currentScale *= 1.3;
    char.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
  });

  document.getElementById('btn-smaller').addEventListener('click', () => {
    currentScale *= 0.7;
    char.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
  });

  document.getElementById('btn-rotate').addEventListener('click', () => {
    currentRotation += 45;
    char.setAttribute('rotation', `0 ${currentRotation} 0`);
  });

  document.getElementById('btn-capture').addEventListener('click', () => {
    const cvs = document.querySelector('canvas');
    const link = document.createElement('a');
    link.download = 'ar_photo.png';
    link.href = cvs.toDataURL('image/png');
    link.click();
  });

  // ピンチ操作（2本指）
  let initialDist = 0;
  window.addEventListener('touchstart', e => {
    if (e.touches.length === 2) {
      initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
    }
  });

  window.addEventListener('touchmove', e => {
    if (e.touches.length === 2 && initialDist > 0) {
      const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
      const diff = dist / initialDist;
      currentScale *= diff;
      char.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
      initialDist = dist;
    }
  });

  // iOS Safari等でのカメラ起動タイミングの補助
  window.addEventListener('load', () => {
    setTimeout(() => {
      window.dispatchEvent(new Event('resize'));
    }, 1000);
  });
</script>
</body>
</html>